<!DOCTYPE html>
<html lang="en" data-theme="emerald">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Receipts - Warehouse FG | Highland Fresh</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />

    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: oklch(var(--b2));
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: oklch(var(--bc) / 0.2);
            border-radius: 3px;
        }

        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="bg-base-200 min-h-screen">

    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-72 bg-base-100 border-r border-base-300 z-50 transform -translate-x-full lg:translate-x-0 sidebar-transition flex flex-col">
        <div class="p-4 border-b border-base-300">
            <div class="flex items-center gap-3">
                <img src="../../images/logo.jpg" alt="Highland Fresh Logo" class="w-10 h-10 rounded-xl object-cover">
                <div class="flex-1 min-w-0">
                    <h1 class="font-bold text-base-content truncate">Highland Fresh</h1>
                    <p class="text-xs text-base-content/60 truncate">Warehouse - Finished Goods</p>
                </div>
                <button class="btn btn-ghost btn-sm btn-square lg:hidden" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin">
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Main Menu</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li><a href="dashboard.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-th-large w-5 text-center text-base-content/60"></i><span>Dashboard</span>
                        </a></li>
                </ul>
            </div>
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Inventory</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li><a href="inventory.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-boxes w-5 text-center text-base-content/60"></i><span>FG Inventory</span>
                        </a></li>
                    <li><a href="chillers.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-temperature-low w-5 text-center text-base-content/60"></i><span>Chiller
                                Storage</span>
                        </a></li>
                </ul>
            </div>
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Operations
                </h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li><a href="receiving.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-truck-loading w-5 text-center text-base-content/60"></i><span>Receive from
                                Production</span>
                        </a></li>
                    <li><a href="delivery_receipts.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-primary text-primary-content">
                            <i class="fas fa-file-invoice w-5 text-center"></i><span>Delivery Receipts</span>
                        </a></li>
                    <li><a href="dispatch.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-truck w-5 text-center text-base-content/60"></i><span>Dispatch</span>
                        </a></li>
                </ul>
            </div>
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Customers</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li><a href="customers.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-users w-5 text-center text-base-content/60"></i><span>Customer List</span>
                        </a></li>
                </ul>
            </div>
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Reports</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li><a href="reports/inventory.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-chart-bar w-5 text-center text-base-content/60"></i><span>Inventory
                                Report</span>
                        </a></li>
                    <li><a href="reports/dispatch.html"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-shipping-fast w-5 text-center text-base-content/60"></i><span>Dispatch
                                Report</span>
                        </a></li>
                </ul>
            </div>
        </nav>

        <div class="p-4 border-t border-base-300">
            <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                    <div class="w-10 rounded-xl bg-primary text-primary-content">
                        <span class="text-sm font-semibold" id="userInitials">FG</span>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm truncate" id="sidebarUserName">Warehouse Staff</p>
                    <p class="text-xs text-base-content/60 truncate">Finished Goods</p>
                </div>
                <div class="dropdown dropdown-top dropdown-end">
                    <label tabindex="0" class="btn btn-ghost btn-sm btn-square"><i
                            class="fas fa-ellipsis-v"></i></label>
                    <ul tabindex="0"
                        class="dropdown-content menu menu-sm bg-base-100 rounded-box shadow-lg border border-base-300 w-44 p-2">
                        <li><a onclick="AuthService.logout()" class="text-error"><i class="fas fa-sign-out-alt w-4"></i>
                                Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-72 min-h-screen flex flex-col">
        <header class="navbar bg-base-100 border-b border-base-300 sticky top-0 z-30 px-4 lg:px-6">
            <div class="flex-none lg:hidden">
                <button class="btn btn-ghost btn-square" onclick="toggleSidebar()"><i
                        class="fas fa-bars text-lg"></i></button>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <i class="fas fa-file-invoice text-primary"></i>
                    <span class="font-semibold">Delivery Receipts</span>
                </div>
            </div>
            <div class="flex-none gap-2">
                <button class="btn btn-primary btn-sm" onclick="openCreateDRModal()">
                    <i class="fas fa-plus"></i> New DR
                </button>
                <label class="swap swap-rotate btn btn-ghost btn-circle">
                    <input type="checkbox" id="themeToggle" />
                    <i class="fas fa-sun swap-off text-lg"></i>
                    <i class="fas fa-moon swap-on text-lg"></i>
                </label>
            </div>
        </header>

        <main class="flex-1 p-4 lg:p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-base-content">Delivery Receipts Management</h1>
                    <p class="text-base-content/60">Create and manage delivery receipts for dispatching goods</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="card bg-base-100 shadow-sm mb-6">
                <div class="card-body p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="form-control">
                            <input type="text" id="searchDR" placeholder="Search DR number..."
                                class="input input-bordered input-sm" onkeyup="filterDRs()">
                        </div>
                        <div class="form-control">
                            <select id="statusFilter" class="select select-bordered select-sm" onchange="filterDRs()">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="dispatched">Dispatched</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <input type="date" id="fromDate" class="input input-bordered input-sm"
                                onchange="filterDRs()">
                        </div>
                        <div class="form-control">
                            <input type="date" id="toDate" class="input input-bordered input-sm" onchange="filterDRs()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approved Sales Orders (Pending DR Creation) -->
            <div class="card bg-base-100 shadow-sm mb-6 border-l-4 border-warning">
                <div class="card-body p-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clipboard-list text-warning text-xl"></i>
                            <h2 class="font-bold text-lg">Approved Sales Orders</h2>
                            <span class="badge badge-warning" id="approvedOrdersCount">0</span>
                        </div>
                        <button class="btn btn-sm btn-ghost" onclick="loadApprovedOrders()">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table table-sm">
                            <thead>
                                <tr class="bg-base-200/50">
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Delivery Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvedOrdersTable">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- DR Table -->
            <div class="card bg-base-100 shadow-sm">
                <div class="card-body p-0">
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr class="bg-base-200">
                                    <th>DR Number</th>
                                    <th>Customer</th>
                                    <th>Type</th>
                                    <th>Items</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="drTable">
                                <tr>
                                    <td colspan="7" class="text-center py-8">
                                        <span class="loading loading-spinner loading-md"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t border-base-300">
            <p class="text-sm text-base-content/60">© 2026 Highland Fresh Dairy. All rights reserved.</p>
        </footer>
    </div>

    <!-- Create DR Modal -->
    <dialog id="createDRModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">Create New Delivery Receipt</h3>
            <form id="createDRForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Customer Type *</span></label>
                        <select id="drCustomerType" class="select select-bordered" required
                            onchange="loadCustomersByType()">
                            <option value="">Select type...</option>
                            <option value="supermarket">Supermarket</option>
                            <option value="school">School/DepEd</option>
                            <option value="distributor">Distributor</option>
                            <option value="retail">Retail</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Customer *</span></label>
                        <select id="drCustomer" class="select select-bordered" required>
                            <option value="">Select customer...</option>
                        </select>
                    </div>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">Delivery Address</span></label>
                    <input type="text" id="drAddress" class="input input-bordered" placeholder="Delivery address...">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Contact Number</span></label>
                        <input type="text" id="drContact" class="input input-bordered" placeholder="Contact number">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Sub-location</span></label>
                        <input type="text" id="drSubLocation" class="input input-bordered"
                            placeholder="Branch/Location">
                    </div>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">Notes</span></label>
                    <textarea id="drNotes" class="textarea textarea-bordered"
                        placeholder="Special instructions..."></textarea>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn" onclick="createDRModal.close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create DR</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- DR Details Modal -->
    <dialog id="drDetailsModal" class="modal">
        <div class="modal-box max-w-3xl">
            <h3 class="font-bold text-lg mb-4">
                <span id="detailDRNumber">DR Details</span>
                <span id="detailDRStatus" class="badge ml-2"></span>
            </h3>

            <div class="bg-base-200 rounded-lg p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-base-content/60">Customer:</span> <strong id="detailCustomer">-</strong>
                    </div>
                    <div><span class="text-base-content/60">Type:</span> <strong id="detailType">-</strong></div>
                    <div><span class="text-base-content/60">Address:</span> <strong id="detailAddress">-</strong></div>
                    <div><span class="text-base-content/60">Created:</span> <strong id="detailCreated">-</strong></div>
                </div>
            </div>

            <h4 class="font-semibold mb-2">Items</h4>
            <div class="overflow-x-auto mb-4">
                <table class="table table-sm">
                    <thead>
                        <tr class="bg-base-200">
                            <th>Product</th>
                            <th>Batch</th>
                            <th class="text-right">Qty</th>
                            <th class="text-right">Unit Price</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="drItemsTable">
                        <tr>
                            <td colspan="5" class="text-center text-base-content/60">No items yet</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="font-bold">
                            <td colspan="4" class="text-right">Grand Total:</td>
                            <td class="text-right" id="drGrandTotal">₱0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Returns Section -->
            <div id="returnsSection" style="display: none;">
                <h4 class="font-semibold mb-2 text-warning"><i class="fas fa-exchange-alt mr-2"></i>Delivery Adjustments
                </h4>
                <div class="overflow-x-auto mb-4">
                    <table class="table table-sm">
                        <thead>
                            <tr class="bg-warning/10">
                                <th>Product</th>
                                <th>Batch</th>
                                <th class="text-right">Qty Returned</th>
                                <th>Reason</th>
                                <th>Condition</th>
                                <th>Disposition</th>
                            </tr>
                        </thead>
                        <tbody id="drReturnsTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="drDetailsModal.close()">Close</button>
                <button type="button" class="btn btn-info" id="btnPickItems" onclick="goToPickItemsFromModal()"
                    style="display: none;">
                    <i class="fas fa-barcode"></i> Pick Items
                </button>
                <button type="button" class="btn btn-outline" id="btnPrintDR" onclick="printCurrentDR()"
                    style="display: none;">
                    <i class="fas fa-print"></i> Print
                </button>
                <button type="button" class="btn btn-primary" id="btnDispatchDR" onclick="dispatchDR()">
                    <i class="fas fa-truck"></i> Dispatch
                </button>
                <button type="button" class="btn btn-warning" id="btnProcessReturns" onclick="openReturnsModal()"
                    style="display: none;">
                    <i class="fas fa-clipboard-check"></i> Driver Returned
                </button>
                <button type="button" class="btn btn-success" id="btnMarkDelivered" onclick="markDelivered()"
                    style="display: none;">
                    <i class="fas fa-check-circle"></i> Mark Delivered
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Returns Processing Modal -->
    <dialog id="returnsModal" class="modal">
        <div class="modal-box max-w-3xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4"><i class="fas fa-clipboard-check text-warning mr-2"></i>Verify Delivery
            </h3>

            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i>
                <span>The driver has returned. Verify what was delivered to the customer. If everything was delivered
                    successfully, click "Complete Delivery". Otherwise, record any returns below.</span>
            </div>

            <div id="returnsContent">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="modal-action">
                <button type="button" class="btn"
                    onclick="document.getElementById('returnsModal').close()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitNoReturns()">
                    <i class="fas fa-check"></i> Complete Delivery - All Good
                </button>
                <button type="button" class="btn btn-warning" onclick="submitReturns()">
                    <i class="fas fa-save"></i> Record Returns & Complete
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- View Order Items Modal -->
    <dialog id="viewOrderItemsModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-clipboard-list text-primary"></i>
                Order Items - <span id="viewOrderNumber" class="font-mono"></span>
            </h3>
            <div class="py-4">
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr class="bg-base-200/50">
                                <th>Product</th>
                                <th class="text-center">Qty</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsTable">
                            <tr>
                                <td colspan="4" class="text-center py-4">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle"></i>
                    <span>Use this information to prepare items before clicking "Prepare for Dispatch"</span>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="toastContainer" class="toast toast-end toast-top z-50"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../../js/config/api.js"></script>
    <script src="../../../js/config/auth.js"></script>
    <script src="../../../js/warehouse/fg.service.js"></script>

    <script>
        let deliveryReceipts = [];
        let customers = [];
        let currentDR = null;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebarBackdrop').classList.toggle('hidden');
        }

        document.getElementById('themeToggle').addEventListener('change', function () {
            document.documentElement.setAttribute('data-theme', this.checked ? 'dark' : 'emerald');
            localStorage.setItem('theme', this.checked ? 'dark' : 'emerald');
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').checked = true;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg`;
            toast.innerHTML = `<span>${message}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const user = AuthService.getCurrentUser();
                if (user) {
                    document.getElementById('sidebarUserName').textContent = `${user.first_name} ${user.last_name}`;
                    document.getElementById('userInitials').textContent = `${user.first_name[0]}${user.last_name[0]}`;
                }
                await loadDeliveryReceipts();
                await loadCustomers();
                await loadApprovedOrders();
            } catch (error) {
                console.error('Init error:', error);
                showToast('Failed to initialize', 'error');
            }
        });

        async function loadReturnsForDR(drId) {
            try {
                const response = await api.get('/warehouse/fg/returns.php', {
                    params: { action: 'list', dr_id: drId }
                });

                const returns = response.data.data || [];

                if (returns.length > 0) {
                    const reasonLabels = {
                        'damaged_in_transit': 'Damaged in Transit',
                        'customer_rejection': 'Customer Rejection',
                        'wrong_order': 'Wrong Order',
                        'customer_not_available': 'Customer Not Available',
                        'wrong_address': 'Wrong Address',
                        'expired_near_expiry': 'Expired/Near Expiry',
                        'quality_issue': 'Quality Issue',
                        'other': 'Other'
                    };

                    const conditionLabels = {
                        'resellable': 'Resellable',
                        'damaged': 'Damaged',
                        'expired': 'Expired',
                        'qc_hold': 'QC Hold'
                    };

                    const dispositionLabels = {
                        'return_to_inventory': 'Returned to Inventory',
                        'dispose': 'Dispose',
                        'qc_review': 'QC Review',
                        'pending': 'Pending'
                    };

                    document.getElementById('drReturnsTable').innerHTML = returns.map(ret => `
                        <tr>
                            <td>${ret.product_name || 'Unknown'}</td>
                            <td><code class="text-xs">${ret.batch_code || 'N/A'}</code></td>
                            <td class="text-right font-semibold text-warning">${ret.quantity_returned}</td>
                            <td><span class="badge badge-sm badge-outline">${reasonLabels[ret.return_reason] || ret.return_reason}</span></td>
                            <td><span class="badge badge-sm ${ret.condition === 'resellable' ? 'badge-success' : ret.condition === 'qc_hold' ? 'badge-warning' : 'badge-error'}">${conditionLabels[ret.condition] || ret.condition}</span></td>
                            <td><span class="badge badge-sm badge-ghost">${dispositionLabels[ret.disposition] || ret.disposition}</span></td>
                        </tr>
                    `).join('');

                    document.getElementById('returnsSection').style.display = 'block';
                } else {
                    document.getElementById('returnsSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load returns:', error);
                document.getElementById('returnsSection').style.display = 'none';
            }
        }

        async function dispatchDR() {
            if (!currentDR) return;

            if (!confirm('Are you sure you want to dispatch this delivery receipt?')) return;

            try {
                await WarehouseFGService.releaseDR(currentDR.id);
                showToast('DR dispatched successfully!', 'success');
                document.getElementById('drDetailsModal').close();
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to dispatch DR:', error);
                showToast('Failed to dispatch DR', 'error');
            }
        }

        async function loadApprovedOrders() {
            try {
                const response = await api.get('/sales/orders.php?action=list&status=approved');
                const orders = response.data || [];
                renderApprovedOrders(orders);
            } catch (error) {
                console.error('Failed to load approved orders:', error);
                document.getElementById('approvedOrdersTable').innerHTML = `
                    <tr><td colspan="6" class="text-center py-4 text-error">Failed to load orders</td></tr>`;
            }
        }

        function renderApprovedOrders(orders) {
            const tbody = document.getElementById('approvedOrdersTable');
            document.getElementById('approvedOrdersCount').textContent = orders.length;

            if (!orders || orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-base-content/60">
                    <i class="fas fa-check-circle text-success mr-2"></i>No pending orders - all caught up!</td></tr>`;
                return;
            }

            tbody.innerHTML = orders.map(o => {
                const hasItems = (o.item_count || 0) > 0;
                return `
                <tr class="hover ${!hasItems ? 'bg-warning/10' : ''}">
                    <td class="font-mono font-medium text-sm">${o.order_number || 'ORD-' + o.id}</td>
                    <td>
                        <div class="font-medium">${o.customer_name || 'Unknown'}</div>
                        <div class="text-xs text-base-content/60">${o.customer_type || ''}</div>
                    </td>
                    <td class="text-sm">${o.delivery_date ? new Date(o.delivery_date).toLocaleDateString() : '-'}</td>
                    <td class="text-center">
                        ${hasItems ? `
                            <button class="btn btn-xs btn-ghost text-primary hover:underline" onclick="viewOrderItems(${o.id}, '${o.order_number || ''}')">
                                ${o.item_count} items
                            </button>
                        ` : `
                            <span class="badge badge-warning badge-sm" title="No items in order - contact Sales">
                                <i class="fas fa-exclamation-triangle mr-1"></i> 0 items
                            </span>
                        `}
                    </td>
                    <td class="text-right font-mono">₱${Number(o.total_amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-xs btn-ghost" onclick="viewOrderItems(${o.id}, '${o.order_number || ''}')" title="View Items">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${hasItems ? `
                                <button class="btn btn-sm btn-primary" onclick="createDRFromOrder(${o.id}, '${o.order_number || ''}')">
                                    <i class="fas fa-clipboard-check"></i> Start Picking
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-disabled" disabled title="Order has no items - contact Sales to add products">
                                    <i class="fas fa-ban"></i> No Items
                                </button>
                            `}
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // View order items in modal
        async function viewOrderItems(orderId, orderNumber) {
            document.getElementById('viewOrderItemsModal').showModal();
            document.getElementById('viewOrderNumber').textContent = orderNumber;
            const tbody = document.getElementById('orderItemsTable');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4"><span class="loading loading-spinner"></span> Loading...</td></tr>`;

            try {
                const response = await api.get('/sales/orders.php?action=detail&id=' + orderId);
                const order = response.data;

                if (!order.items || order.items.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8">
                        <div class="flex flex-col items-center gap-2 text-warning">
                            <i class="fas fa-exclamation-triangle text-3xl"></i>
                            <p class="font-semibold">No Items in This Order</p>
                            <p class="text-sm text-base-content/60">Please contact the Sales Custodian to add products to this order before it can be prepared for dispatch.</p>
                        </div>
                    </td></tr>`;
                    return;
                }

                tbody.innerHTML = order.items.map(item => `
                    <tr>
                        <td>
                            <div class="font-medium">${item.product_name || 'Unknown Product'}</div>
                            <div class="text-xs text-base-content/60">${item.product_code || ''}</div>
                        </td>
                        <td class="text-center">${item.quantity || item.quantity_ordered || 0}</td>
                        <td class="text-right">₱${Number(item.unit_price || 0).toFixed(2)}</td>
                        <td class="text-right font-medium">₱${Number(item.line_total || item.subtotal || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load order items:', error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-error">Failed to load items</td></tr>`;
            }
        }

        async function createDRFromOrder(orderId, orderNumber) {
            if (!confirm('Start picking items for order ' + orderNumber + '?\n\nYou will scan/pick items, then generate the final DR.')) return;
            try {
                const response = await api.post('/warehouse/fg/delivery_receipts.php?action=create_from_order', {
                    order_id: orderId
                });

                showToast('Picking ticket created. Redirecting to scan items...', 'success');

                // Redirect to dispatch page to start scanning items
                if (response.data?.redirect_url) {
                    setTimeout(() => {
                        window.location.href = response.data.redirect_url;
                    }, 1000);
                } else {
                    // Fallback: refresh and show pending tickets
                    await loadDeliveryReceipts();
                    await loadApprovedOrders();
                }
            } catch (error) {
                console.error('Error creating picking ticket:', error);
                showToast(error.response?.data?.message || 'Failed to create picking ticket', 'error');
            }
        }

        async function loadDeliveryReceipts() {
            try {
                const response = await WarehouseFGService.getDeliveryReceipts();
                deliveryReceipts = response.data || [];
                renderDRTable(deliveryReceipts);
            } catch (error) {
                console.error('Failed to load DRs:', error);
                document.getElementById('drTable').innerHTML = `
                    <tr><td colspan="7" class="text-center py-8 text-error">Failed to load delivery receipts</td></tr>`;
            }
        }

        async function loadCustomers() {
            try {
                const response = await WarehouseFGService.getCustomers();
                customers = response.data || [];
            } catch (error) {
                console.error('Failed to load customers:', error);
            }
        }

        function loadCustomersByType() {
            const type = document.getElementById('drCustomerType').value;
            const select = document.getElementById('drCustomer');
            select.innerHTML = '<option value="">Select customer...</option>';

            const filtered = type ? customers.filter(c => c.customer_type === type) : customers;
            filtered.forEach(c => {
                select.innerHTML += `<option value="${c.id}" data-address="${c.address || ''}">${c.name}</option>`;
            });
        }

        function renderDRTable(drs) {
            const tbody = document.getElementById('drTable');

            if (!drs || drs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-base-content/60">No delivery receipts found</td></tr>`;
                return;
            }

            const statusColors = {
                'draft': 'badge-ghost',
                'pending': 'badge-warning',
                'preparing': 'badge-info',
                'ready': 'badge-accent',
                'dispatched': 'badge-primary',
                'delivered': 'badge-success',
                'cancelled': 'badge-error'
            };

            tbody.innerHTML = drs.map(dr => `
                <tr>
                    <td><code class="font-mono font-semibold">${dr.dr_number}</code></td>
                    <td>
                        <div class="font-medium">${dr.customer_name}</div>
                        <div class="text-xs text-base-content/60">${dr.sub_location || ''}</div>
                    </td>
                    <td><span class="badge badge-outline badge-sm">${dr.customer_type || 'N/A'}</span></td>
                    <td>${dr.item_count || 0} items</td>
                    <td>${new Date(dr.created_at).toLocaleDateString()}</td>
                    <td><span class="badge ${statusColors[dr.status] || 'badge-ghost'} badge-sm">${dr.status}</span></td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-ghost btn-xs" onclick="viewDRDetails(${dr.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${dr.status === 'preparing' ? `
                                <button class="btn btn-xs btn-info" onclick="goToPickItems(${dr.id})" title="Pick Items (Scan Barcodes)">
                                    <i class="fas fa-barcode"></i> Pick
                                </button>
                            ` : ''}
                            ${dr.status === 'ready' ? `
                                <button class="btn btn-ghost btn-xs text-success" onclick="printDR(${dr.id})" title="Print DR">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="btn btn-ghost btn-xs text-primary" onclick="quickDispatch(${dr.id})" title="Dispatch">
                                    <i class="fas fa-truck"></i>
                                </button>
                            ` : ''}
                            ${dr.status === 'dispatched' && !dr.returns_processed ? `
                                <button class="btn btn-ghost btn-xs text-warning" onclick="viewDRDetails(${dr.id})" title="Driver Returned - Verify Delivery">
                                    <i class="fas fa-clipboard-check"></i>
                                </button>
                            ` : ''}
                            ${dr.status === 'dispatched' && dr.returns_processed ? `
                                <button class="btn btn-ghost btn-xs text-success" onclick="quickMarkDelivered(${dr.id})" title="Mark Delivered">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                            ` : ''}
                            ${dr.status === 'delivered' ? `
                                <button class="btn btn-ghost btn-xs text-success" onclick="printDR(${dr.id})" title="Print DR">
                                    <i class="fas fa-print"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterDRs() {
            const search = document.getElementById('searchDR').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;

            let filtered = deliveryReceipts.filter(dr => {
                const matchSearch = !search || dr.dr_number.toLowerCase().includes(search) ||
                    (dr.customer_name && dr.customer_name.toLowerCase().includes(search));
                const matchStatus = !status || dr.status === status;
                const matchFrom = !from || new Date(dr.created_at) >= new Date(from);
                const matchTo = !to || new Date(dr.created_at) <= new Date(to + 'T23:59:59');
                return matchSearch && matchStatus && matchFrom && matchTo;
            });

            renderDRTable(filtered);
        }

        function openCreateDRModal() {
            document.getElementById('createDRForm').reset();
            document.getElementById('drCustomer').innerHTML = '<option value="">Select customer...</option>';
            document.getElementById('createDRModal').showModal();
        }

        document.getElementById('createDRForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const customerSelect = document.getElementById('drCustomer');
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];

            const data = {
                customer_type: document.getElementById('drCustomerType').value,
                customer_name: selectedOption.text,
                customer_id: document.getElementById('drCustomer').value,
                delivery_address: document.getElementById('drAddress').value,
                contact_number: document.getElementById('drContact').value,
                sub_location: document.getElementById('drSubLocation').value,
                notes: document.getElementById('drNotes').value
            };

            try {
                const response = await WarehouseFGService.createDeliveryReceipt(data);
                showToast(`DR ${response.data.dr_number} created successfully!`, 'success');
                document.getElementById('createDRModal').close();
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to create DR:', error);
                showToast('Failed to create delivery receipt', 'error');
            }
        });

        async function viewDRDetails(id) {
            try {
                const response = await WarehouseFGService.getDeliveryReceipt(id);
                currentDR = response.data;

                document.getElementById('detailDRNumber').textContent = currentDR.dr_number;
                document.getElementById('detailDRStatus').textContent = currentDR.status;
                document.getElementById('detailDRStatus').className = `badge badge-${currentDR.status === 'delivered' ? 'success' : currentDR.status === 'dispatched' ? 'primary' : 'warning'}`;
                document.getElementById('detailCustomer').textContent = currentDR.customer_name;
                document.getElementById('detailType').textContent = currentDR.customer_type || 'N/A';
                document.getElementById('detailAddress').textContent = currentDR.delivery_address || 'N/A';
                document.getElementById('detailCreated').textContent = new Date(currentDR.created_at).toLocaleString();

                const items = currentDR.items || [];
                if (items.length > 0) {
                    let total = 0;
                    document.getElementById('drItemsTable').innerHTML = items.map(item => {
                        const qty = parseFloat(item.quantity) || 0;
                        const price = parseFloat(item.unit_price) || 0;
                        const lineTotal = qty * price;
                        total += lineTotal;
                        return `
                            <tr>
                                <td>${item.product_name || 'Unknown'}</td>
                                <td><code class="text-xs">${item.batch_code || 'N/A'}</code></td>
                                <td class="text-right">${qty}</td>
                                <td class="text-right">₱${price.toFixed(2)}</td>
                                <td class="text-right">₱${lineTotal.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('');
                    document.getElementById('drGrandTotal').textContent = `₱${total.toFixed(2)}`;
                } else {
                    document.getElementById('drItemsTable').innerHTML = `<tr><td colspan="5" class="text-center text-base-content/60">No items yet</td></tr>`;
                    document.getElementById('drGrandTotal').textContent = '₱0.00';
                }

                // Load returns if DR is dispatched or delivered
                if (currentDR.status === 'dispatched' || currentDR.status === 'delivered') {
                    await loadReturnsForDR(id);
                } else {
                    document.getElementById('returnsSection').style.display = 'none';
                }

                // Show/hide action buttons based on status
                document.getElementById('btnPickItems').style.display =
                    currentDR.status === 'preparing' ? 'inline-flex' : 'none';

                document.getElementById('btnPrintDR').style.display =
                    ['ready', 'dispatched', 'delivered'].includes(currentDR.status) ? 'inline-flex' : 'none';

                document.getElementById('btnDispatchDR').style.display =
                    currentDR.status === 'ready' ? 'inline-flex' : 'none';

                document.getElementById('btnProcessReturns').style.display =
                    (currentDR.status === 'dispatched' && !currentDR.returns_processed) ? 'inline-flex' : 'none';

                document.getElementById('btnMarkDelivered').style.display =
                    (currentDR.status === 'dispatched' && currentDR.returns_processed) ? 'inline-flex' : 'none';

                document.getElementById('drDetailsModal').showModal();
            } catch (error) {
                console.error('Failed to load DR details:', error);
                showToast('Failed to load DR details', 'error');
            }
        }

        async function dispatchDR() {
            if (!currentDR) return;

            if (!confirm('Are you sure you want to dispatch this delivery receipt?')) return;

            try {
                await WarehouseFGService.releaseDR(currentDR.id);
                showToast('DR dispatched successfully!', 'success');
                document.getElementById('drDetailsModal').close();
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to dispatch DR:', error);
                showToast('Failed to dispatch DR', 'error');
            }
        }

        async function quickDispatch(id) {
            if (!confirm('Dispatch this delivery receipt?')) return;

            try {
                await WarehouseFGService.releaseDR(id);
                showToast('DR dispatched!', 'success');
                await loadDeliveryReceipts();
            } catch (error) {
                showToast('Failed to dispatch', 'error');
            }
        }

        async function quickMarkDelivered(id) {
            if (!confirm('Mark this delivery as completed?')) return;

            try {
                await api.put('/warehouse/fg/delivery_receipts.php', {
                    action: 'deliver',
                    id: id
                });
                showToast('Delivery confirmed!', 'success');
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to mark delivered:', error);
                showToast(error.response?.data?.message || 'Failed to confirm delivery', 'error');
            }
        }

        async function openReturnsModal() {
            if (!currentDR) return;

            const items = currentDR.items || [];

            if (items.length === 0) {
                showToast('No items found in this DR', 'error');
                return;
            }

            // Build returns form
            const returnsHTML = items.map((item, index) => `
                <div class="card bg-base-200 mb-3">
                    <div class="card-body p-4">
                        <h4 class="font-semibold">${item.product_name}</h4>
                        <div class="text-sm text-base-content/60 mb-2">
                            Batch: ${item.batch_code || 'N/A'} | Dispatched: ${item.quantity_packed || item.quantity_ordered}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label"><span class="label-text">Qty Returned</span></label>
                                <input type="number" id="return_qty_${index}" class="input input-bordered input-sm" min="0" max="${item.quantity_packed || item.quantity_ordered}" value="0" step="1">
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text">Reason</span></label>
                                <select id="return_reason_${index}" class="select select-bordered select-sm">
                                    <option value="">No return</option>
                                    <option value="damaged_in_transit">Damaged in Transit</option>
                                    <option value="customer_rejection">Customer Rejection</option>
                                    <option value="wrong_order">Wrong Order</option>
                                    <option value="customer_not_available">Customer Not Available</option>
                                    <option value="wrong_address">Wrong Address</option>
                                    <option value="expired_near_expiry">Expired/Near Expiry</option>
                                    <option value="quality_issue">Quality Issue</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-control col-span-2" id="condition_${index}_container" style="display: none;">
                                <label class="label"><span class="label-text">Condition</span></label>
                                <select id="return_condition_${index}" class="select select-bordered select-sm">
                                    <option value="resellable">Resellable (Return to Inventory)</option>
                                    <option value="damaged">Damaged (Dispose)</option>
                                    <option value="expired">Expired (Dispose)</option>
                                    <option value="qc_hold">QC Hold (Review Required)</option>
                                </select>
                            </div>
                            <div class="form-control col-span-2" id="notes_${index}_container" style="display: none;">
                                <label class="label"><span class="label-text">Notes</span></label>
                                <textarea id="return_notes_${index}" class="textarea textarea-bordered textarea-sm" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <input type="hidden" id="return_dr_item_id_${index}" value="${item.id}">
                        <input type="hidden" id="return_product_id_${index}" value="${item.product_id}">
                        <input type="hidden" id="return_batch_id_${index}" value="${item.batch_id || ''}">
                    </div>
                </div>
            `).join('');

            document.getElementById('returnsContent').innerHTML = returnsHTML;

            // Add event listeners to show/hide condition and notes fields
            items.forEach((item, index) => {
                document.getElementById(`return_qty_${index}`).addEventListener('input', function () {
                    const hasReturn = parseFloat(this.value) > 0;
                    document.getElementById(`condition_${index}_container`).style.display = hasReturn ? 'block' : 'none';
                    document.getElementById(`notes_${index}_container`).style.display = hasReturn ? 'block' : 'none';
                });

                document.getElementById(`return_reason_${index}`).addEventListener('change', function () {
                    const hasReason = this.value !== '';
                    if (hasReason) {
                        const qtyInput = document.getElementById(`return_qty_${index}`);
                        if (parseFloat(qtyInput.value) === 0) {
                            qtyInput.value = 1;
                            qtyInput.dispatchEvent(new Event('input'));
                        }
                    }
                });
            });

            document.getElementById('returnsModal').showModal();
        }

        async function submitReturns() {
            if (!currentDR) return;

            const items = currentDR.items || [];
            const returns = [];

            for (let i = 0; i < items.length; i++) {
                const qty = parseFloat(document.getElementById(`return_qty_${i}`).value || 0);
                const reason = document.getElementById(`return_reason_${i}`).value;

                if (qty > 0 && reason) {
                    const condition = document.getElementById(`return_condition_${i}`).value;
                    const disposition = condition === 'resellable' ? 'return_to_inventory' :
                        condition === 'qc_hold' ? 'qc_review' : 'dispose';

                    returns.push({
                        dr_item_id: document.getElementById(`return_dr_item_id_${i}`).value,
                        product_id: document.getElementById(`return_product_id_${i}`).value,
                        batch_id: document.getElementById(`return_batch_id_${i}`).value || null,
                        quantity_returned: qty,
                        return_reason: reason,
                        condition: condition,
                        disposition: disposition,
                        notes: document.getElementById(`return_notes_${i}`).value || null
                    });
                }
            }

            if (returns.length === 0) {
                showToast('Please enter return quantities and reasons', 'warning');
                return;
            }

            const totalQtyReturned = returns.reduce((sum, r) => sum + r.quantity_returned, 0);
            if (!confirm(`Record ${totalQtyReturned} unit(s) returned across ${returns.length} product(s)?`)) return;

            try {
                await api.post('/warehouse/fg/returns.php', {
                    action: 'record_returns',
                    dr_id: currentDR.id,
                    returns: returns
                });

                showToast('Returns recorded successfully!', 'success');
                document.getElementById('returnsModal').close();
                document.getElementById('drDetailsModal').close();
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to record returns:', error);
                showToast(error.response?.data?.message || 'Failed to record returns', 'error');
            }
        }

        async function submitNoReturns() {
            if (!currentDR) return;

            if (!confirm('Confirm all items were delivered successfully (no returns)?')) return;

            try {
                await api.post('/warehouse/fg/returns.php', {
                    action: 'no_returns',
                    dr_id: currentDR.id
                });

                showToast('Marked as no returns - all delivered!', 'success');
                document.getElementById('returnsModal').close();
                document.getElementById('drDetailsModal').close();
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to mark no returns:', error);
                showToast(error.response?.data?.message || 'Failed to process', 'error');
            }
        }

        async function markDelivered() {
            if (!currentDR) return;

            if (!confirm('Confirm this delivery has been completed?\n\nThis will mark the order as delivered and make it available for collection.')) return;

            try {
                await api.put('/warehouse/fg/delivery_receipts.php', {
                    action: 'deliver',
                    id: currentDR.id
                });
                showToast('Delivery confirmed successfully!', 'success');
                document.getElementById('drDetailsModal').close();
                await loadDeliveryReceipts();
            } catch (error) {
                console.error('Failed to mark delivered:', error);
                showToast(error.response?.data?.message || 'Failed to confirm delivery', 'error');
            }
        }

        function editDR(id) {
            showToast('Edit feature coming soon', 'info');
        }

        function goToPickItems(drId) {
            // Redirect to dispatch page with DR pre-selected
            window.location.href = `dispatch.html?dr=${drId}`;
        }

        function goToPickItemsFromModal() {
            if (!currentDR) return;
            window.location.href = `dispatch.html?dr=${currentDR.id}`;
        }

        function printCurrentDR() {
            if (!currentDR) return;
            printDR(currentDR.id);
        }

        async function printDR(drId) {
            try {
                // Fetch DR details for printing
                const response = await WarehouseFGService.getDeliveryReceipt(drId);
                const dr = response.data;

                if (!dr) {
                    showToast('DR not found', 'error');
                    return;
                }

                // Only allow print for 'ready', 'dispatched', or 'delivered' status
                if (!['ready', 'dispatched', 'delivered'].includes(dr.status)) {
                    showToast('DR must be fully picked before printing. Status: ' + dr.status, 'warning');
                    return;
                }

                // Create print window
                const printWindow = window.open('', '_blank', 'width=800,height=600');

                // Build items table HTML
                const items = dr.items || [];
                let itemsHtml = '';
                let totalAmount = 0;

                items.forEach((item, idx) => {
                    const qty = parseFloat(item.quantity_packed) || parseFloat(item.quantity_ordered) || 0;
                    const price = parseFloat(item.unit_price) || 0;
                    const lineTotal = qty * price;
                    totalAmount += lineTotal;

                    itemsHtml += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${idx + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.product_name || 'Unknown'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 11px;">${item.batch_code || 'N/A'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${qty}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">₱${price.toFixed(2)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">₱${lineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Delivery Receipt - ${dr.dr_number}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                padding: 20px; 
                                max-width: 800px; 
                                margin: 0 auto;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 30px;
                                border-bottom: 2px solid #333;
                                padding-bottom: 20px;
                            }
                            .header h1 { 
                                margin: 0; 
                                color: #2a5934;
                                font-size: 24px;
                            }
                            .header p { 
                                margin: 5px 0; 
                                color: #666;
                            }
                            .dr-title {
                                font-size: 20px;
                                font-weight: bold;
                                text-align: center;
                                margin: 20px 0;
                                color: #333;
                            }
                            .info-grid { 
                                display: grid; 
                                grid-template-columns: 1fr 1fr; 
                                gap: 20px;
                                margin-bottom: 20px;
                            }
                            .info-box {
                                background: #f9f9f9;
                                padding: 15px;
                                border-radius: 5px;
                            }
                            .info-box h3 {
                                margin: 0 0 10px 0;
                                font-size: 14px;
                                color: #666;
                                text-transform: uppercase;
                            }
                            .info-box p {
                                margin: 5px 0;
                                font-size: 14px;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 20px 0;
                            }
                            th { 
                                background: #2a5934; 
                                color: white; 
                                padding: 10px 8px;
                                text-align: left;
                                font-size: 12px;
                            }
                            th:nth-child(4), th:nth-child(5), th:nth-child(6) {
                                text-align: right;
                            }
                            .total-row {
                                font-weight: bold;
                                background: #f0f0f0;
                            }
                            .signatures {
                                margin-top: 50px;
                                display: grid;
                                grid-template-columns: 1fr 1fr 1fr;
                                gap: 30px;
                            }
                            .signature-box {
                                text-align: center;
                            }
                            .signature-line {
                                border-top: 1px solid #333;
                                margin-top: 50px;
                                padding-top: 10px;
                            }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 11px;
                                color: #666;
                            }
                            @media print {
                                body { margin: 0; padding: 15px; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>HIGHLAND FRESH DAIRY CORPORATION</h1>
                            <p>TESTING LANG  AMBOT NAUNSA NANI</p>
                            <p>Tel: (053) 832-1234 | Email: info@highlandfresh.com</p>
                        </div>
                        
                        <div class="dr-title">DELIVERY RECEIPT</div>
                        
                        <div class="info-grid">
                            <div class="info-box">
                                <h3>DR Information</h3>
                                <p><strong>DR Number:</strong> ${dr.dr_number}</p>
                                <p><strong>Date:</strong> ${new Date(dr.created_at).toLocaleDateString()}</p>
                                <p><strong>Status:</strong> ${dr.status.toUpperCase()}</p>
                                ${dr.order_number ? `<p><strong>Order Ref:</strong> ${dr.order_number}</p>` : ''}
                            </div>
                            <div class="info-box">
                                <h3>Customer Details</h3>
                                <p><strong>${dr.customer_name || 'N/A'}</strong></p>
                                <p>${dr.delivery_address || 'N/A'}</p>
                                <p>Contact: ${dr.contact_number || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>Product Description</th>
                                    <th>Batch Code</th>
                                    <th style="text-align: center;">Qty</th>
                                    <th style="text-align: right;">Unit Price</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                                <tr class="total-row">
                                    <td colspan="5" style="padding: 10px 8px; border: 1px solid #ddd; text-align: right;">TOTAL AMOUNT:</td>
                                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: right;">₱${totalAmount.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="signatures">
                            <div class="signature-box">
                                <div class="signature-line">
                                    <strong>Prepared By</strong><br>
                                    <small>Date: __________</small>
                                </div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">
                                    <strong>Delivered By</strong><br>
                                    <small>Date: __________</small>
                                </div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">
                                    <strong>Received By</strong><br>
                                    <small>Date: __________</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>This document serves as official delivery receipt. Please check items upon receipt.</p>
                            <p>Printed on: ${new Date().toLocaleString()}</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 30px;">
                            <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; cursor: pointer; background: #2a5934; color: white; border: none; border-radius: 5px;">
                                Print DR
                            </button>
                        </div>
                    </body>
                    </html>
                `);

                printWindow.document.close();

            } catch (error) {
                console.error('Failed to print DR:', error);
                showToast('Failed to load DR for printing', 'error');
            }
        }
    </script>
</body>

</html>