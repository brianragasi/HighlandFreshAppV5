<!DOCTYPE html>
<html lang="en" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Labels - Quality Control | Highland Fresh</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <!-- JsBarcode for generating barcodes -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bento-card { @apply transition-all duration-300 ease-out hover:-translate-y-1 hover:shadow-lg; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: oklch(var(--b2)); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: oklch(var(--bc) / 0.2); border-radius: 3px; }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Print styles */
        @media print {
            body { background: white !important; padding: 0 !important; margin: 0 !important; }
            .no-print { display: none !important; }
            #sidebar { display: none !important; }
            #labelsContainer { 
                display: flex !important; 
                flex-wrap: wrap !important;
                justify-content: center !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .label-container { 
                page-break-inside: avoid; 
                margin: 0.25in !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            @page { size: auto; margin: 0.5in; }
        }
        
        @media screen {
            .print-only { display: none !important; }
        }
        
        .label-container {
            border: 2px solid #000;
            padding: 0.25in;
            background: white;
            page-break-inside: avoid;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">
    
    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-base-100 border-r border-base-300 z-50 transform -translate-x-full lg:translate-x-0 sidebar-transition flex flex-col">
        <div class="p-4 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center">
                    <i class="fas fa-flask text-primary text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h1 class="font-bold text-base-content truncate">Highland Fresh</h1>
                    <p class="text-xs text-base-content/60 truncate">Quality Control</p>
                </div>
                <button class="btn btn-ghost btn-sm btn-square lg:hidden" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin">
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Main Menu</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li>
                        <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-th-large w-5 text-center text-base-content/60"></i>
                            <span class="flex-1">Dashboard</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Inbound Milk</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li>
                        <a href="milk_receiving.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-truck-loading w-5 text-center text-base-content/60"></i>
                            <span class="flex-1">Milk Receiving</span>
                        </a>
                    </li>
                    <li>
                        <a href="milk_grading.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-flask w-5 text-center text-base-content/60"></i>
                            <span class="flex-1">Milk Grading</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Production QC</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li>
                        <a href="batch_release.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-check-double w-5 text-center text-base-content/60"></i>
                            <span class="flex-1">Batch Release</span>
                        </a>
                    </li>
                    <li>
                        <a href="print-labels.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-primary text-primary-content">
                            <i class="fas fa-barcode w-5 text-center"></i>
                            <span class="flex-1">Print Labels</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div>
                <h2 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-2 px-3">Inventory QC</h2>
                <ul class="menu menu-sm p-0 gap-1">
                    <li>
                        <a href="expiry_management.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-base-200">
                            <i class="fas fa-calendar-times w-5 text-center text-base-content/60"></i>
                            <span class="flex-1">Expiry Management</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        
        <!-- User Profile -->
        <div class="p-4 border-t border-base-300">
            <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                    <div class="bg-primary/10 text-primary rounded-full w-10">
                        <span id="userInitials">QC</span>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-sm truncate" id="userName">QC Staff</p>
                    <p class="text-xs text-base-content/60">Quality Control</p>
                </div>
                <button onclick="logout()" class="btn btn-ghost btn-sm btn-square" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <div class="lg:ml-72 min-h-screen flex flex-col">
        <!-- Top Bar -->
        <header class="bg-base-100 border-b border-base-300 sticky top-0 z-30 no-print">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center gap-3">
                    <button class="btn btn-ghost btn-sm btn-square lg:hidden" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="text-lg font-bold">Print Barcode Labels</h1>
                        <p class="text-xs text-base-content/60">Generate and print labels for released batches</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <a href="batch_release.html" class="btn btn-ghost btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Batch Release
                    </a>
                </div>
            </div>
        </header>
        
        <!-- Content -->
        <main class="flex-1 p-4 lg:p-6">
            <!-- Controls -->
            <div class="card bg-base-100 shadow-sm mb-6 no-print">
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text font-medium">Select Batch</span></label>
                            <select id="batchSelect" class="select select-bordered" onchange="loadBatchDetails()">
                                <option value="">Loading batches...</option>
                            </select>
                        </div>
                        
                        <div class="form-control">
                            <label class="label"><span class="label-text font-medium">Number of Labels</span></label>
                            <input type="number" id="labelCount" class="input input-bordered" value="1" min="1" max="100">
                        </div>
                        
                        <div class="form-control">
                            <label class="label"><span class="label-text font-medium">Label Size</span></label>
                            <select id="labelSize" class="select select-bordered" onchange="regenerateLabels()">
                                <option value="large">Large (4" x 3")</option>
                                <option value="medium">Medium (3" x 2")</option>
                                <option value="small">Small (2" x 1")</option>
                            </select>
                        </div>
                        
                        <div class="form-control">
                            <label class="label"><span class="label-text">&nbsp;</span></label>
                            <div class="flex gap-2">
                                <button class="btn btn-primary flex-1" onclick="generateLabels()">
                                    <i class="fas fa-barcode"></i> Generate
                                </button>
                                <button class="btn btn-success" onclick="printLabels()" id="printBtn" disabled title="Print Labels">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Batch Info Card -->
            <div id="batchInfoCard" class="card bg-base-100 shadow-sm mb-6 no-print" style="display: none;">
                <div class="card-body">
                    <h2 class="card-title text-lg">
                        <i class="fas fa-info-circle text-primary"></i>
                        Batch Information
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <span class="text-xs text-base-content/60">Batch Code</span>
                            <div class="font-bold font-mono" id="infoBatchCode">-</div>
                        </div>
                        <div>
                            <span class="text-xs text-base-content/60">Barcode</span>
                            <div class="font-mono font-bold" id="infoBarcode">
                                <span class="text-error">Not Generated</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-xs text-base-content/60">Product</span>
                            <div class="font-bold" id="infoProduct">-</div>
                        </div>
                        <div>
                            <span class="text-xs text-base-content/60">Quantity</span>
                            <div class="font-bold" id="infoQuantity">-</div>
                        </div>
                        <div>
                            <span class="text-xs text-base-content/60">Manufacturing Date</span>
                            <div class="font-bold" id="infoMfgDate">-</div>
                        </div>
                        <div>
                            <span class="text-xs text-base-content/60">Expiry Date</span>
                            <div class="font-bold text-error" id="infoExpDate">-</div>
                        </div>
                        <div>
                            <span class="text-xs text-base-content/60">Status</span>
                            <div id="infoStatus">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Labels Preview -->
            <div id="labelsContainer" class="flex flex-wrap gap-4 justify-center print-area">
                <div class="text-center text-base-content/40 py-12 w-full no-print">
                    <i class="fas fa-tags text-6xl mb-4"></i>
                    <p>Select a batch and click "Generate" to preview labels</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Print Area (shown only when printing) -->
    <div id="printArea" class="print-only hidden"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/config/api.js"></script>
    <script src="../../js/config/auth.js"></script>
    
    <script>
        let currentBatch = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!AuthService.isAuthenticated()) {
                window.location.href = '../login.html';
                return;
            }
            
            const user = AuthService.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = `${user.first_name} ${user.last_name}`;
                document.getElementById('userInitials').textContent = 
                    (user.first_name?.charAt(0) || '') + (user.last_name?.charAt(0) || '');
            }
            
            await loadReleasedBatches();
            
            // Check for batch_id in URL
            const urlParams = new URLSearchParams(window.location.search);
            const batchId = urlParams.get('batch_id');
            if (batchId) {
                document.getElementById('batchSelect').value = batchId;
                await loadBatchDetails();
                generateLabels();
            }
        });
        
        async function loadReleasedBatches() {
            try {
                const response = await api.get('/qc/batch_release.php?action=list&status=released&limit=50');
                const batches = response.data || [];
                
                const select = document.getElementById('batchSelect');
                select.innerHTML = '<option value="">Select a released batch...</option>';
                
                batches.forEach(b => {
                    const expiry = b.expiry_date ? new Date(b.expiry_date).toLocaleDateString() : 'N/A';
                    const productName = b.product_name || 'Unknown Product';
                    select.innerHTML += `<option value="${b.id}">${b.batch_code} - ${productName} (Exp: ${expiry})</option>`;
                });
                
                if (batches.length === 0) {
                    select.innerHTML = '<option value="">No released batches found</option>';
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                document.getElementById('batchSelect').innerHTML = '<option value="">Error loading batches</option>';
            }
        }
        
        async function loadBatchDetails() {
            const select = document.getElementById('batchSelect');
            const batchId = select.value;
            
            if (!batchId) {
                document.getElementById('batchInfoCard').style.display = 'none';
                currentBatch = null;
                return;
            }
            
            try {
                // FIXED: Use batch_id parameter (not id)
                const response = await api.get(`/qc/batch_release.php?batch_id=${batchId}`);
                currentBatch = response.data;
                
                // Display batch info
                document.getElementById('batchInfoCard').style.display = 'block';
                document.getElementById('infoBatchCode').textContent = currentBatch.batch_code || '-';
                
                if (currentBatch.barcode) {
                    document.getElementById('infoBarcode').innerHTML = `<span class="text-success">${currentBatch.barcode}</span>`;
                } else {
                    document.getElementById('infoBarcode').innerHTML = '<span class="text-error">Not Generated</span>';
                }
                
                document.getElementById('infoProduct').textContent = currentBatch.product_name || '-';
                document.getElementById('infoQuantity').textContent = (currentBatch.quantity_produced || currentBatch.expected_yield || '-') + ' units';
                document.getElementById('infoMfgDate').textContent = currentBatch.manufacturing_date ? new Date(currentBatch.manufacturing_date).toLocaleDateString() : '-';
                document.getElementById('infoExpDate').textContent = currentBatch.expiry_date ? new Date(currentBatch.expiry_date).toLocaleDateString() : '-';
                
                const statusBadge = currentBatch.qc_status === 'released' 
                    ? '<span class="badge badge-success">Released</span>'
                    : `<span class="badge">${currentBatch.qc_status || 'Unknown'}</span>`;
                document.getElementById('infoStatus').innerHTML = statusBadge;
                
            } catch (error) {
                console.error('Error loading batch details:', error);
                document.getElementById('batchInfoCard').style.display = 'none';
            }
        }
        
        function generateLabels() {
            if (!currentBatch) {
                alert('Please select a batch first');
                return;
            }
            
            if (!currentBatch.barcode) {
                alert('This batch does not have a barcode. Please ensure QC has released the batch properly.');
                return;
            }
            
            const count = parseInt(document.getElementById('labelCount').value) || 1;
            const size = document.getElementById('labelSize').value;
            
            const container = document.getElementById('labelsContainer');
            container.innerHTML = '';
            
            const sizes = {
                large: { width: '4in', height: '3in', barcodeHeight: 60 },
                medium: { width: '3in', height: '2in', barcodeHeight: 45 },
                small: { width: '2in', height: '1in', barcodeHeight: 30 }
            };
            const sizeConfig = sizes[size];
            
            for (let i = 0; i < count; i++) {
                const label = createLabel(currentBatch, sizeConfig);
                container.appendChild(label);
            }
            
            // Generate all barcodes
            document.querySelectorAll('.barcode-svg').forEach(svg => {
                JsBarcode(svg, currentBatch.barcode, {
                    format: "CODE128",
                    width: 2,
                    height: sizeConfig.barcodeHeight,
                    displayValue: true,
                    fontSize: size === 'small' ? 10 : 14,
                    margin: 5
                });
            });
            
            document.getElementById('printBtn').disabled = false;
        }
        
        function createLabel(batch, sizeConfig) {
            const div = document.createElement('div');
            div.className = 'label-container bg-white';
            div.style.width = sizeConfig.width;
            div.style.height = sizeConfig.height;
            
            const mfgDate = batch.manufacturing_date ? new Date(batch.manufacturing_date).toLocaleDateString('en-PH') : '-';
            const expDate = batch.expiry_date ? new Date(batch.expiry_date).toLocaleDateString('en-PH') : '-';
            
            if (sizeConfig.width === '2in') {
                div.innerHTML = `
                    <div class="text-center h-full flex flex-col justify-between py-1">
                        <div class="text-xs font-bold truncate">${batch.product_name || 'Product'}</div>
                        <svg class="barcode-svg mx-auto"></svg>
                        <div class="text-[8px]">EXP: ${expDate}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="text-lg font-bold">Highland Fresh</div>
                                <div class="text-xs text-gray-500">Quality Dairy Products</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-mono">${batch.batch_code}</div>
                            </div>
                        </div>
                        
                        <div class="text-xl font-bold text-center mb-2">${batch.product_name || 'Dairy Product'}</div>
                        
                        <div class="flex-1 flex items-center justify-center">
                            <svg class="barcode-svg"></svg>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs border-t pt-2 mt-2">
                            <div>
                                <span class="text-gray-500">MFG:</span>
                                <span class="font-semibold">${mfgDate}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-500">EXP:</span>
                                <span class="font-bold text-red-600">${expDate}</span>
                            </div>
                        </div>
                        
                        ${sizeConfig.width === '4in' ? `
                        <div class="text-center text-[10px] text-gray-400 mt-1">
                            Store at 4°C or below • ${batch.recipe_variant || ''}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            return div;
        }
        
        function regenerateLabels() {
            if (currentBatch) {
                generateLabels();
            }
        }
        
        function printLabels() {
            window.print();
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            sidebar.classList.toggle('-translate-x-full');
            backdrop.classList.toggle('hidden');
        }
        
        function logout() {
            AuthService.logout();
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
