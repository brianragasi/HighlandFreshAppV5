<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmers - Highland Fresh System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="user-avatar" style="width:40px;height:40px;font-size:1.25rem;">
                        <i class="fas fa-cow"></i>
                    </div>
                    <div>
                        <div class="sidebar-logo-text">Highland Fresh</div>
                        <div class="sidebar-logo-subtitle">Quality Control</div>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main Menu</div>
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-th-large"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Inbound Milk</div>
                    <a href="milk_receiving.html" class="nav-link">
                        <i class="fas fa-truck-loading"></i>
                        <span>Milk Receiving</span>
                    </a>
                    <a href="milk_grading.html" class="nav-link">
                        <i class="fas fa-flask"></i>
                        <span>Milk Grading</span>
                    </a>
                    <a href="farmers.html" class="nav-link active">
                        <i class="fas fa-users"></i>
                        <span>Farmers</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Production QC</div>
                    <a href="batch_release.html" class="nav-link">
                        <i class="fas fa-check-double"></i>
                        <span>Batch Release</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Inventory QC</div>
                    <a href="expiry_management.html" class="nav-link">
                        <i class="fas fa-calendar-times"></i>
                        <span>Expiry Management</span>
                    </a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 class="header-title">Farmers</h1>
                    <div class="header-breadcrumb">
                        <a href="dashboard.html">Dashboard</a>
                        <i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>
                        <span>Farmers</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openNewFarmerModal()">
                        <i class="fas fa-plus"></i>
                        Add Farmer
                    </button>
                    
                    <button class="header-icon-btn" title="Logout" onclick="AuthService.logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>
            
            <!-- Page Content -->
            <div class="page-content">
                <!-- Stats -->
                <div class="grid-4 mb-4">
                    <div class="stat-card">
                        <div class="stat-card-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-card-value" id="totalFarmers">0</div>
                        <div class="stat-card-label">Total Farmers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon success">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-card-value" id="memberCount">0</div>
                        <div class="stat-card-label">Members (₱40/L)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon warning">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="stat-card-value" id="nonMemberCount">0</div>
                        <div class="stat-card-label">Non-Members (₱38/L)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon info">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-card-value" id="activeCount">0</div>
                        <div class="stat-card-label">Active</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-3 align-center">
                            <div class="form-group mb-0" style="min-width: 200px;">
                                <input type="text" class="form-control" id="filterSearch" placeholder="Search name or code...">
                            </div>
                            <div class="form-group mb-0" style="min-width: 150px;">
                                <select class="form-control" id="filterMembership">
                                    <option value="">All Types</option>
                                    <option value="member">Members</option>
                                    <option value="non_member">Non-Members</option>
                                </select>
                            </div>
                            <div class="form-group mb-0" style="min-width: 150px;">
                                <select class="form-control" id="filterStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="">All</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="loadFarmers()">
                                <i class="fas fa-search"></i>
                                Filter
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Farmers Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i>
                            Farmer List
                        </h3>
                        <span class="text-muted" id="totalRecords">0 records</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Membership</th>
                                        <th>Base Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="farmersTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted p-4">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="pagination" id="pagination"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- New Farmer Modal -->
    <div class="modal-overlay" id="farmerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="farmerModalTitle">
                    <i class="fas fa-user-plus text-primary"></i>
                    Add New Farmer
                </h3>
                <button class="modal-close" onclick="closeModal('farmerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="farmerForm" onsubmit="submitFarmer(event)">
                <input type="hidden" id="farmerId">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">First Name</label>
                            <input type="text" class="form-control" id="farmerFirstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Last Name</label>
                            <input type="text" class="form-control" id="farmerLastName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="farmerContact" placeholder="e.g., 09171234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="farmerAddress" rows="2" placeholder="Complete address..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Membership Type</label>
                        <select class="form-control" id="farmerMembership" required>
                            <option value="member">Member (₱40.00/L)</option>
                            <option value="non_member">Non-Member (₱38.00/L)</option>
                        </select>
                    </div>
                    
                    <hr style="margin: 1rem 0;">
                    <h5 class="mb-3">Bank Information (Optional)</h5>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="farmerBankName" placeholder="e.g., BDO, BPI">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="farmerBankAccount" placeholder="Account number">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('farmerModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitFarmerBtn">
                        <i class="fas fa-save"></i>
                        Save Farmer
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Farmer Modal -->
    <div class="modal-overlay" id="viewFarmerModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user text-primary"></i>
                    Farmer Details - <span id="viewFarmerCode">-</span>
                </h3>
                <button class="modal-close" onclick="closeModal('viewFarmerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="grid-2 mb-4">
                    <div>
                        <h4 id="viewFarmerName">-</h4>
                        <span class="badge" id="viewFarmerMembership">-</span>
                    </div>
                    <div class="text-right">
                        <div class="text-muted">Base Price</div>
                        <div class="font-bold text-primary" style="font-size: 1.5rem;" id="viewFarmerPrice">-</div>
                    </div>
                </div>
                
                <div class="grid-2 mb-4">
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--border-radius);">
                        <div class="text-muted mb-1">Contact</div>
                        <div id="viewFarmerContact">-</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--border-radius);">
                        <div class="text-muted mb-1">Address</div>
                        <div id="viewFarmerAddress">-</div>
                    </div>
                </div>
                
                <h5 class="mb-3">Delivery Statistics</h5>
                <div class="grid-4">
                    <div class="stat-card">
                        <div class="stat-card-value" id="viewTotalDeliveries">0</div>
                        <div class="stat-card-label">Total Deliveries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="viewAcceptedLiters">0</div>
                        <div class="stat-card-label">Liters Accepted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="viewRejectedLiters">0</div>
                        <div class="stat-card-label">Liters Rejected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="viewAvgFat">-</div>
                        <div class="stat-card-label">Avg Fat %</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewFarmerModal')">Close</button>
                <button class="btn btn-primary" onclick="editFarmerFromView()">
                    <i class="fas fa-edit"></i>
                    Edit Farmer
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/config/api.js"></script>
    <script src="../../js/config/auth.js"></script>
    <script src="../../js/qc/farmers.service.js"></script>
    <script>
        // Require QC role
        AuthService.requireRole(['qc_officer', 'general_manager']);
        
        let currentPage = 1;
        const limit = 20;
        let currentFarmerId = null;
        let allFarmers = [];
        
        // Load farmers
        async function loadFarmers() {
            const table = document.getElementById('farmersTable');
            table.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-4"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            
            try {
                const params = {
                    page: currentPage,
                    limit: limit,
                    search: document.getElementById('filterSearch').value,
                    membership: document.getElementById('filterMembership').value,
                    status: document.getElementById('filterStatus').value
                };
                
                const response = await FarmersService.getAll(params);
                
                if (response.success) {
                    allFarmers = response.data;
                    document.getElementById('totalRecords').textContent = `${response.pagination.total} records`;
                    
                    // Update stats
                    updateStats();
                    
                    if (response.data.length > 0) {
                        table.innerHTML = response.data.map(f => `
                            <tr>
                                <td><code class="font-medium">${f.farmer_code}</code></td>
                                <td>
                                    <div class="font-medium">${f.first_name} ${f.last_name}</div>
                                </td>
                                <td>${f.contact_number || '<span class="text-muted">-</span>'}</td>
                                <td>
                                    <span class="badge ${f.membership_type === 'member' ? 'badge-success' : 'badge-secondary'}">
                                        ${f.membership_type === 'member' ? 'Member' : 'Non-Member'}
                                    </span>
                                </td>
                                <td class="font-medium">${formatCurrency(f.base_price_per_liter)}/L</td>
                                <td>
                                    <span class="badge ${f.is_active ? 'badge-success' : 'badge-danger'}">
                                        ${f.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btn btn-sm btn-secondary" onclick="viewFarmer(${f.id})" title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="editFarmer(${f.id})" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        table.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-4">No farmers found</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Failed to load farmers:', error);
                table.innerHTML = '<tr><td colspan="7" class="text-center text-danger p-4">Failed to load farmers</td></tr>';
            }
        }
        
        async function updateStats() {
            try {
                // Get all farmers for stats
                const allResponse = await FarmersService.getAll({ limit: 1000 });
                if (allResponse.success) {
                    const farmers = allResponse.data;
                    document.getElementById('totalFarmers').textContent = allResponse.pagination.total;
                    document.getElementById('memberCount').textContent = farmers.filter(f => f.membership_type === 'member').length;
                    document.getElementById('nonMemberCount').textContent = farmers.filter(f => f.membership_type === 'non_member').length;
                    document.getElementById('activeCount').textContent = farmers.filter(f => f.is_active).length;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        // Modal functions
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function openNewFarmerModal() {
            document.getElementById('farmerForm').reset();
            document.getElementById('farmerId').value = '';
            document.getElementById('farmerModalTitle').innerHTML = '<i class="fas fa-user-plus text-primary"></i> Add New Farmer';
            document.getElementById('submitFarmerBtn').innerHTML = '<i class="fas fa-save"></i> Save Farmer';
            openModal('farmerModal');
        }
        
        async function editFarmer(id) {
            try {
                const response = await FarmersService.getById(id);
                if (response.success) {
                    const f = response.data;
                    document.getElementById('farmerId').value = f.id;
                    document.getElementById('farmerFirstName').value = f.first_name;
                    document.getElementById('farmerLastName').value = f.last_name;
                    document.getElementById('farmerContact').value = f.contact_number || '';
                    document.getElementById('farmerAddress').value = f.address || '';
                    document.getElementById('farmerMembership').value = f.membership_type;
                    document.getElementById('farmerBankName').value = f.bank_name || '';
                    document.getElementById('farmerBankAccount').value = f.bank_account_number || '';
                    
                    document.getElementById('farmerModalTitle').innerHTML = '<i class="fas fa-user-edit text-primary"></i> Edit Farmer';
                    document.getElementById('submitFarmerBtn').innerHTML = '<i class="fas fa-save"></i> Update Farmer';
                    openModal('farmerModal');
                }
            } catch (error) {
                showNotification('Error', 'Failed to load farmer details', 'error');
            }
        }
        
        async function viewFarmer(id) {
            try {
                const response = await FarmersService.getById(id);
                if (response.success) {
                    const f = response.data;
                    currentFarmerId = f.id;
                    
                    document.getElementById('viewFarmerCode').textContent = f.farmer_code;
                    document.getElementById('viewFarmerName').textContent = `${f.first_name} ${f.last_name}`;
                    document.getElementById('viewFarmerMembership').textContent = f.membership_type === 'member' ? 'Member' : 'Non-Member';
                    document.getElementById('viewFarmerMembership').className = 'badge ' + (f.membership_type === 'member' ? 'badge-success' : 'badge-secondary');
                    document.getElementById('viewFarmerPrice').textContent = formatCurrency(f.base_price_per_liter) + '/L';
                    document.getElementById('viewFarmerContact').textContent = f.contact_number || '-';
                    document.getElementById('viewFarmerAddress').textContent = f.address || '-';
                    
                    // Stats
                    const stats = f.statistics || {};
                    document.getElementById('viewTotalDeliveries').textContent = stats.total_deliveries || 0;
                    document.getElementById('viewAcceptedLiters').textContent = (stats.total_liters_accepted || 0).toLocaleString();
                    document.getElementById('viewRejectedLiters').textContent = (stats.total_liters_rejected || 0).toLocaleString();
                    document.getElementById('viewAvgFat').textContent = stats.avg_fat_percentage ? stats.avg_fat_percentage + '%' : '-';
                    
                    openModal('viewFarmerModal');
                }
            } catch (error) {
                showNotification('Error', 'Failed to load farmer details', 'error');
            }
        }
        
        function editFarmerFromView() {
            closeModal('viewFarmerModal');
            editFarmer(currentFarmerId);
        }
        
        async function submitFarmer(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitFarmerBtn');
            btn.disabled = true;
            
            const id = document.getElementById('farmerId').value;
            const data = {
                first_name: document.getElementById('farmerFirstName').value,
                last_name: document.getElementById('farmerLastName').value,
                contact_number: document.getElementById('farmerContact').value,
                address: document.getElementById('farmerAddress').value,
                membership_type: document.getElementById('farmerMembership').value,
                bank_name: document.getElementById('farmerBankName').value,
                bank_account_number: document.getElementById('farmerBankAccount').value
            };
            
            try {
                let response;
                if (id) {
                    response = await FarmersService.update(id, data);
                } else {
                    response = await FarmersService.create(data);
                }
                
                if (response.success) {
                    showNotification('Success', id ? 'Farmer updated successfully' : 'Farmer added successfully', 'success');
                    closeModal('farmerModal');
                    loadFarmers();
                }
            } catch (error) {
                showNotification('Error', error.message || 'Failed to save farmer', 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // Initial load
        loadFarmers();
        
        // Search on enter
        document.getElementById('filterSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loadFarmers();
        });
    </script>
</body>
</html>
